<!DOCTYPE html>
<html lang="en" data-theme="slate">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sanctuary | For Divija</title>
  <style>
    :root {
      --font-sans: 'Segoe UI', system-ui, -apple-system, sans-serif;
      --font-mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 40px -10px rgba(0,0,0,0.40);
      --shadow-lg: 0 20px 60px -15px rgba(0,0,0,0.55);
      --transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      --transition-slow: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    [data-theme="slate"] {
      --bg: #0f172a; --bg-alt: #1e293b; --card: #1e293b; --card-hover: #334155;
      --text: #f8fafc; --muted: #94a3b8; --muted2: #64748b;
      --border: #334155; --border-focus: #818cf8;
      --accent: #818cf8; --accent-glow: rgba(129, 140, 248, 0.30);
      --success: #34d399; --success-glow: rgba(52, 211, 153, 0.30);
      --danger: #f87171; --danger-glow: rgba(248, 113, 113, 0.30);
      --warn: #fbbf24; --warn-glow: rgba(251, 191, 36, 0.30);
      --info: #60a5fa;
    }

    [data-theme="warm"] {
      --bg: #fef7ed; --bg-alt: #fff7ed; --card: #ffffff; --card-hover: #fef3e2;
      --text: #292524; --muted: #78716c; --muted2: #a8a29e;
      --border: #e7e5e4; --border-focus: #d97706;
      --accent: #d97706; --accent-glow: rgba(217, 119, 6, 0.20);
      --success: #059669; --success-glow: rgba(5, 150, 105, 0.20);
      --danger: #dc2626; --danger-glow: rgba(220, 38, 38, 0.20);
      --warn: #d97706; --warn-glow: rgba(217, 119, 6, 0.20);
      --info: #2563eb;
    }

    [data-theme="midnight"] {
      --bg: #000000; --bg-alt: #0a0a0a; --card: #111111; --card-hover: #1a1a1a;
      --text: #e5e5e5; --muted: #737373; --muted2: #525252;
      --border: #262626; --border-focus: #a78bfa;
      --accent: #a78bfa; --accent-glow: rgba(167, 139, 250, 0.30);
      --success: #4ade80; --success-glow: rgba(74, 222, 128, 0.30);
      --danger: #f43f5e; --danger-glow: rgba(244, 63, 94, 0.30);
      --warn: #facc15; --warn-glow: rgba(250, 204, 21, 0.30);
      --info: #38bdf8;
    }

    [data-theme="forest"] {
      --bg: #0c1a14; --bg-alt: #132a1f; --card: #1a3829; --card-hover: #234d36;
      --text: #ecfdf5; --muted: #86efac; --muted2: #4ade80;
      --border: #2d5a42; --border-focus: #4ade80;
      --accent: #4ade80; --accent-glow: rgba(74, 222, 128, 0.30);
      --success: #86efac; --success-glow: rgba(134, 239, 172, 0.30);
      --danger: #fda4af; --danger-glow: rgba(253, 164, 175, 0.30);
      --warn: #fde047; --warn-glow: rgba(253, 224, 71, 0.30);
      --info: #7dd3fc;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background var(--transition-slow), color var(--transition-slow);
      overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-alt); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.25rem;
      display: grid;
      gap: 1.25rem;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 340px 1fr 400px;
      gap: 1.25rem;
      height: calc(100vh - 140px);
    }

    @media (max-width: 1400px) {
      .main-grid { grid-template-columns: 300px 1fr 360px; }
    }
    @media (max-width: 1100px) {
      .main-grid { grid-template-columns: 1fr; height: auto; }
      .app { height: auto; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      transition: border-color var(--transition), box-shadow var(--transition);
      overflow: hidden;
      min-height: 240px;
    }

    .card:hover { border-color: color-mix(in srgb, var(--accent) 30%, var(--border)); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      gap: 0.75rem;
    }

    .card-title {
      font-size: 0.8rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      white-space: nowrap;
    }

    .card-actions { display: flex; gap: 0.375rem; flex-wrap: wrap; justify-content: flex-end; }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-right: -4px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      gap: 1rem;
    }

    .brand { display: flex; align-items: center; gap: 0.875rem; min-width: 260px; }
    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 70%, #fff));
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 1.5rem;
      box-shadow: 0 8px 24px var(--accent-glow);
      transition: transform var(--transition);
      user-select: none;
    }
    .logo:hover { transform: scale(1.05) rotate(-3deg); }

    .brand h1 { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.5px; }
    .brand p { font-size: 0.75rem; color: var(--muted); }

    .header-controls { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-end; flex: 1; }
    .clock { text-align: right; min-width: 160px; }
    .clock-time {
      font-family: var(--font-mono);
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -1px;
      line-height: 1;
    }
    .clock-date { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

    .btn {
      padding: 0.625rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card);
      color: var(--text);
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
      overflow: hidden;
      user-select: none;
    }
    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255,255,255,0.10));
      opacity: 0;
      transition: opacity var(--transition);
    }
    .btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn:hover::before { opacity: 1; }
    .btn:active { transform: translateY(0) scale(0.985); }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 80%, #000));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 16px var(--accent-glow);
    }
    .btn-primary:hover { box-shadow: 0 8px 24px var(--accent-glow); }

    .btn-success {
      background: linear-gradient(135deg, var(--success), color-mix(in srgb, var(--success) 80%, #000));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 16px var(--success-glow);
    }
    .btn-warn {
      background: linear-gradient(135deg, var(--warn), color-mix(in srgb, var(--warn) 80%, #000));
      border-color: transparent;
      color: #000;
    }
    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }

    .btn-ghost { background: transparent; color: var(--muted); }
    .btn-ghost:hover { color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, transparent); }

    .btn-icon { width: 34px; height: 34px; padding: 0; font-size: 1rem; }
    .btn-sm { padding: 0.375rem 0.625rem; font-size: 0.75rem; }
    .btn-block { width: 100%; }

    .input, .select {
      width: 100%;
      padding: 0.625rem 0.875rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.875rem;
      font-family: inherit;
      transition: all var(--transition);
    }
    .input:focus, .select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .form-group { margin-bottom: 0.875rem; }
    .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* EXAMS */
    .exam-item {
      padding: 0.875rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .exam-item:hover {
      transform: translateX(4px);
      background: var(--card-hover);
      border-color: var(--accent);
    }
    .exam-item.today {
      border-left-color: var(--danger);
      background: linear-gradient(90deg, var(--danger-glow), transparent);
      animation: pulse-border 2s infinite;
    }
    .exam-item.tomorrow {
      border-left-color: var(--warn);
      background: linear-gradient(90deg, var(--warn-glow), transparent);
    }
    .exam-item.completed { opacity: 0.55; border-left-color: var(--success); }
    .exam-item.completed .exam-title { text-decoration: line-through; }

    .exam-date { font-family: var(--font-mono); font-size: 0.7rem; color: var(--muted2); }
    .exam-title { font-weight: 700; font-size: 0.9rem; }
    .exam-countdown { font-family: var(--font-mono); font-size: 0.75rem; color: var(--accent); white-space: nowrap; }

    .exam-actions { display: flex; gap: 0.25rem; opacity: 0; transition: opacity var(--transition); }
    .exam-item:hover .exam-actions { opacity: 1; }

    .tag {
      font-size: 0.6rem;
      font-weight: 900;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .tag-today { background: var(--danger); color: white; }
    .tag-tomorrow { background: var(--warn); color: #000; }
    .tag-soon { background: var(--info); color: white; }

    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 0 0 var(--danger-glow); }
      50% { box-shadow: 0 0 0 8px transparent; }
    }

    /* TASKS */
    .task-item {
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      display: grid;
      grid-template-columns: 88px 1fr auto;
      gap: 0.75rem;
      align-items: center;
      cursor: grab;
      transition: all var(--transition);
      user-select: none;
    }
    .task-item:hover { background: var(--card-hover); border-color: var(--accent); }
    .task-item.dragging { opacity: 0.5; transform: scale(1.02); box-shadow: var(--shadow-lg); }
    .task-item.drag-over { border-color: var(--accent); border-style: dashed; }
    .task-item.active { border-left: 3px solid var(--success); background: linear-gradient(90deg, var(--success-glow), transparent); }
    .task-item.done { opacity: 0.55; }
    .task-item.done .task-title { text-decoration: line-through; }

    .task-time { font-family: var(--font-mono); font-size: 0.78rem; color: var(--muted); }
    .task-title { font-weight: 750; font-size: 0.9rem; }
    .task-duration { font-size: 0.72rem; color: var(--muted2); margin-top: 2px; }
    .task-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.62rem;
      font-weight: 900;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 15%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent) 40%, transparent);
      color: var(--text);
      margin-top: 6px;
      width: fit-content;
    }

    .task-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: all var(--transition);
    }
    .task-item.active .task-status {
      background: var(--success);
      box-shadow: 0 0 12px var(--success);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.25); opacity: 0.7; }
    }

    /* TIMER */
    .timer-container { display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0 0.25rem; }
    .timer-ring { width: 200px; height: 200px; position: relative; margin-bottom: 0.75rem; }
    .timer-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-ring circle { fill: none; stroke-width: 6; }
    .timer-ring .bg { stroke: var(--border); }
    .timer-ring .progress {
      stroke: url(#timerGradient);
      stroke-linecap: round;
      stroke-dasharray: 591;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.35s linear, filter var(--transition);
    }
    .timer-ring.running .progress { filter: drop-shadow(0 0 10px var(--accent)); }

    .timer-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .timer-big {
      font-family: var(--font-mono);
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: -2px;
      line-height: 1;
    }
    .timer-status { font-size: 0.75rem; color: var(--muted); margin-top: 0.35rem; min-height: 18px; }

    .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; width: 100%; margin-top: 0.5rem; }
    .subject-select { margin-bottom: 0.75rem; }

    /* ENERGY */
    .energy-checkin {
      background: linear-gradient(135deg, var(--accent-glow), transparent);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 0.75rem;
      animation: fadeIn 0.5s ease;
    }
    .energy-title { font-weight: 800; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .energy-scale { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.375rem; }
    .energy-option {
      padding: 0.5rem;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-align: center;
      font-size: 1.25rem;
      transition: all var(--transition);
    }
    .energy-option:hover { transform: scale(1.08); border-color: var(--accent); }
    .energy-option.selected { background: var(--accent); border-color: var(--accent); transform: scale(1.08); }

    /* LOG */
    .log-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 0.375rem;
      font-size: 0.8rem;
      animation: slideIn 0.3s ease;
      border: 1px solid transparent;
    }
    .log-item:hover { border-color: color-mix(in srgb, var(--accent) 25%, transparent); }
    .log-subject { font-weight: 800; }
    .log-time { font-size: 0.7rem; color: var(--muted2); }
    .log-duration { font-family: var(--font-mono); color: var(--success); font-weight: 900; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: auto;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .stat-card { background: var(--bg); border-radius: var(--radius-sm); padding: 0.75rem; text-align: center; }
    .stat-value { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 900; color: var(--accent); }
    .stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.80);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-slow);
      padding: 1rem;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.92) translateY(18px);
      transition: all var(--transition-slow);
      box-shadow: var(--shadow-lg);
    }
    .modal-overlay.open .modal { transform: scale(1) translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; }
    .modal-title { font-size: 1.25rem; font-weight: 900; }
    .modal-body { margin-bottom: 1.25rem; }
    .modal-text { color: var(--muted); line-height: 1.6; margin-bottom: 1rem; }
    .modal-actions { display: flex; flex-direction: column; gap: 0.5rem; }

    /* BREATHING */
    .breathing-circle {
      width: 140px; height: 140px;
      margin: 1.6rem auto 1.25rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 60%, #fff));
      display: grid;
      place-items: center;
      color: white;
      font-weight: 900;
      animation: breathe 8s ease-in-out infinite;
      box-shadow: 0 0 60px var(--accent-glow);
      user-select: none;
    }
    @keyframes breathe {
      0%, 100% { transform: scale(0.85); opacity: 0.75; }
      50% { transform: scale(1.20); opacity: 1; }
    }

    /* CONFETTI */
    #confetti { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }

    /* SHORTCUTS PANEL */
    .shortcuts-panel {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      font-size: 0.7rem;
      color: var(--muted);
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(10px);
      transition: all var(--transition);
      z-index: 100;
      max-width: 320px;
    }
    .shortcuts-panel.visible { opacity: 1; transform: translateY(0); }
    .shortcut-row { display: flex; justify-content: space-between; gap: 1rem; margin-bottom: 0.25rem; }
    .shortcut-row:last-child { margin-bottom: 0; }

    kbd {
      background: var(--bg);
      padding: 0.15rem 0.4rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--text);
    }

    /* TOASTS */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 2000;
    }
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--success);
      border-radius: var(--radius-sm);
      padding: 0.875rem 1.1rem;
      box-shadow: var(--shadow);
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 360px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .toast.show { transform: translateX(0); }
    .toast.warn { border-left-color: var(--warn); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--info); }
    .toast-icon { font-size: 1.25rem; }

    /* RIPPLE INDICATOR */
    .ripple-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      padding: 1.25rem 1.75rem;
      text-align: center;
      box-shadow: var(--shadow-lg);
      z-index: 1500;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition);
    }
    .ripple-indicator.visible { opacity: 1; visibility: visible; animation: rippleIn 0.5s ease; }
    @keyframes rippleIn {
      0% { transform: translate(-50%, -50%) scale(0.82); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    .ripple-amount { font-family: var(--font-mono); font-size: 2rem; font-weight: 900; color: var(--accent); }

    /* DATE NAV */
    .date-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      justify-content: flex-start;
    }
    .date-badge {
      font-size: 0.65rem;
      font-weight: 900;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      white-space: nowrap;
      user-select: none;
    }

    /* EMPTY STATES */
    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--muted); }
    .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.55; }
    .empty-text { font-size: 0.875rem; margin-bottom: 1rem; }

    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: stretch; text-align: center; }
      .header-controls { justify-content: center; }
      .clock { text-align: center; }
      .timer-ring { width: 170px; height: 170px; }
      .timer-big { font-size: 2.6rem; }
      .shortcuts-panel { display: none; }
    }
  </style>
</head>

<body>
  <!-- SVG Gradients -->
  <svg width="0" height="0" style="position: absolute;">
    <defs>
      <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:var(--accent)"></stop>
        <stop offset="100%" style="stop-color:color-mix(in srgb, var(--accent) 60%, #fff)"></stop>
      </linearGradient>
    </defs>
  </svg>

  <canvas id="confetti"></canvas>

  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo" id="btn-onboarding" title="Help / Onboarding" role="button" aria-label="Open onboarding">üìö</div>
        <div>
          <h1>Sanctuary</h1>
          <p>Ultimate Adaptive Navigator ‚Ä¢ UK Time</p>
        </div>
      </div>

      <div class="header-controls">
        <div class="clock">
          <div class="clock-time" id="clock-time">00:00</div>
          <div class="clock-date" id="clock-date">Loading...</div>
        </div>

        <select class="select" id="theme-select" style="width:auto; padding:0.5rem;" aria-label="Theme">
          <option value="slate">üåô Slate</option>
          <option value="warm">‚òÄÔ∏è Warm</option>
          <option value="midnight">üåë Midnight</option>
          <option value="forest">üå≤ Forest</option>
        </select>

        <button class="btn btn-icon" id="btn-export" title="Export Backup" aria-label="Export backup">üì•</button>
        <button class="btn btn-icon" id="btn-import" title="Import Backup" aria-label="Import backup">üì§</button>
        <button class="btn btn-icon" id="btn-shortcuts" title="Keyboard Shortcuts" aria-label="Keyboard shortcuts">‚å®Ô∏è</button>
        <input type="file" id="import-file" accept=".json" style="display:none" />
      </div>
    </header>

    <main class="main-grid">
      <!-- LEFT: Exam Horizon -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">üìÖ Exam Horizon</h2>
          <div class="card-actions">
            <button class="btn btn-icon btn-ghost" id="btn-add-exam" title="Add Exam" aria-label="Add exam">+</button>
          </div>
        </div>
        <div class="scroll-area" id="exam-list"></div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-done">0</div>
            <div class="stat-label">Exams Done</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-hours">0h</div>
            <div class="stat-label">Studied</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-streak">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-left">0</div>
            <div class="stat-label">Exams Left</div>
          </div>
        </div>
      </section>

      <!-- MIDDLE: Daily Planner -->
      <section class="card">
        <div class="card-header" style="align-items:flex-start;">
          <div style="display:flex; flex-direction:column; gap:0.35rem; width:100%;">
            <h2 class="card-title">üìã Daily Plan</h2>
            <div class="date-nav">
              <button class="btn btn-icon btn-ghost" id="btn-date-prev" title="Previous day" aria-label="Previous day">‚Üê</button>
              <input type="date" class="input" id="selected-date" style="max-width: 170px; padding:0.45rem 0.6rem;" aria-label="Selected date" />
              <button class="btn btn-icon btn-ghost" id="btn-date-next" title="Next day" aria-label="Next day">‚Üí</button>
              <span class="date-badge" id="selected-date-tag">‚Äî</span>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn btn-sm btn-ghost" id="btn-generate-plan" title="Generate Study Blocks" aria-label="Generate plan">‚ú® Generate</button>
            <button class="btn btn-sm btn-warn" id="btn-ripple" title="Ripple Shift Tasks" aria-label="Ripple shift">‚âã Ripple</button>
            <button class="btn btn-icon btn-ghost" id="btn-add-task" title="Add Task" aria-label="Add task">+</button>
          </div>
        </div>
        <div class="scroll-area" id="task-list"></div>
      </section>

      <!-- RIGHT: Focus Engine -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">‚è±Ô∏è Focus Engine</h2>
          <div class="card-actions">
            <button class="btn btn-icon btn-ghost" id="btn-energy" title="Energy check-in" aria-label="Energy check-in">‚ö°</button>
          </div>
        </div>

        <div class="energy-checkin" id="energy-checkin">
          <div class="energy-title">üåü How‚Äôs your energy?</div>
          <div class="energy-scale">
            <button class="energy-option" data-energy="1" title="Very Low" aria-label="Energy 1">üò¥</button>
            <button class="energy-option" data-energy="2" title="Low" aria-label="Energy 2">üòï</button>
            <button class="energy-option" data-energy="3" title="Okay" aria-label="Energy 3">üòê</button>
            <button class="energy-option" data-energy="4" title="Good" aria-label="Energy 4">üòä</button>
            <button class="energy-option" data-energy="5" title="High" aria-label="Energy 5">üöÄ</button>
          </div>
        </div>

        <select class="select subject-select" id="subject-select" aria-label="Focus subject">
          <option value="">Select Focus Subject...</option>
        </select>

        <div class="timer-container">
          <div class="timer-ring" id="timer-ring">
            <svg viewBox="0 0 200 200" aria-label="Timer">
              <circle class="bg" cx="100" cy="100" r="94"></circle>
              <circle class="progress" id="timer-progress" cx="100" cy="100" r="94"></circle>
            </svg>
            <div class="timer-value">
              <div class="timer-big" id="timer-display">25:00</div>
              <div class="timer-status" id="timer-status">Ready to focus</div>
            </div>
          </div>
        </div>

        <div class="timer-controls">
          <button class="btn btn-primary btn-block" id="btn-timer-toggle">‚ñ∂Ô∏è START</button>
          <button class="btn btn-warn btn-block" id="btn-life-happens">üöß Life Happens</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr auto auto; gap:0.5rem; margin-top: 1rem;">
          <select class="select" id="quick-subject" style="font-size:0.8rem;" aria-label="Quick log subject">
            <option value="">Quick log‚Ä¶</option>
          </select>
          <input type="number" class="input" id="quick-minutes" placeholder="Mins" min="1" max="480" style="width: 78px; font-size:0.8rem;" aria-label="Quick log minutes" />
          <button class="btn btn-sm btn-success" id="btn-quick-add" aria-label="Add quick log">+</button>
        </div>

        <div style="margin-top:1rem; flex:1; overflow:hidden; display:flex; flex-direction:column;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
            <span class="form-label" style="margin:0;">Today‚Äôs Log</span>
            <button class="btn btn-sm btn-ghost" id="btn-clear-log">Clear</button>
          </div>
          <div class="scroll-area" id="log-list" style="max-height: 180px;"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->

  <div class="modal-overlay" id="modal-life-happens">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üöß Life Happened</h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-life-happens" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-text">Reality is messy. That‚Äôs okay. How should we adapt?</p>
        <div class="modal-actions">
          <button class="btn btn-block" data-action="pause">‚è∏Ô∏è Just Pause (Resume Later)</button>
          <button class="btn btn-block" data-action="log-ripple">üìù Log Progress & Ripple +15m</button>
          <button class="btn btn-block" data-action="log">‚úÖ Log Progress & Reset</button>
          <button class="btn btn-block" data-action="cancel">üö´ Cancel Session</button>
          <button class="btn btn-danger btn-block" data-action="breathe">üßò I‚Äôm Stressed (Breathe)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-breathing">
    <div class="modal" style="text-align:center;">
      <div class="modal-header">
        <h3 class="modal-title">üßò Center Yourself</h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-breathing" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-text">Breathe in as it expands. Breathe out as it contracts. You‚Äôre safe.</p>
        <div class="breathing-circle">In / Out</div>
      </div>
      <button class="btn btn-primary btn-block" data-close="modal-breathing">‚ú® I‚Äôm Ready</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-exam">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-exam-title">‚ûï Add Exam</h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-exam" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input type="date" class="input" id="exam-date" />
        </div>
        <div class="form-group">
          <label class="form-label">Subjects (comma separated)</label>
          <input type="text" class="input" id="exam-subjects" placeholder="e.g. Physics, Chemistry" />
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="select" id="exam-type">
            <option value="exam">Exam</option>
            <option value="deadline">Deadline</option>
            <option value="event">Event</option>
          </select>
        </div>
        <input type="hidden" id="exam-edit-id" />
      </div>
      <div style="display:flex; gap:0.5rem;">
        <button class="btn btn-primary btn-block" id="btn-save-exam">üíæ Save</button>
        <button class="btn btn-danger" id="btn-delete-exam" style="display:none;" title="Delete exam" aria-label="Delete exam">üóëÔ∏è</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-task">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-task-title">‚ûï Add Task</h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-task" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Task Name</label>
          <input type="text" class="input" id="task-title" placeholder="e.g. Review Physics notes" />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
          <div class="form-group">
            <label class="form-label">Start Time</label>
            <input type="time" class="input" id="task-start" value="09:00" />
          </div>
          <div class="form-group">
            <label class="form-label">Duration (mins)</label>
            <input type="number" class="input" id="task-duration" value="45" min="5" max="240" />
          </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.75rem;">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select class="select" id="task-type">
              <option value="study">Study</option>
              <option value="break">Break</option>
              <option value="buffer">Buffer</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Subject</label>
            <select class="select" id="task-subject">
              <option value="">(Optional)</option>
            </select>
          </div>
        </div>
        <input type="hidden" id="task-edit-id" />
      </div>
      <button class="btn btn-primary btn-block" id="btn-save-task">üíæ Save Task</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-ripple">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚âã Ripple Shift</h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-ripple" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-text">Shift remaining tasks forward. Overlaps are automatically resolved.</p>
        <div class="form-group">
          <label class="form-label">Delay (minutes)</label>
          <input type="number" class="input" id="ripple-amount" value="15" min="5" max="180" />
        </div>
      </div>
      <button class="btn btn-warn btn-block" id="btn-confirm-ripple">‚âã Apply Ripple Shift</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-onboarding">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Welcome to Sanctuary mf </h3>
        <button class="btn btn-icon btn-ghost" data-close="modal-onboarding" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="onboarding-text"></p>
        <div style="display:flex; gap:0.5rem; margin-top: 1rem;">
          <button class="btn btn-ghost btn-block" id="btn-onboarding-skip">Skip</button>
          <button class="btn btn-primary btn-block" id="btn-onboarding-next">Next</button>
        </div>
        <div style="margin-top:0.75rem; color:var(--muted2); font-size:0.75rem;">
          Tip: press <kbd>?</kbd> anytime to see shortcuts.
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <div class="shortcuts-panel" id="shortcuts-panel">
    <div style="font-weight:900; margin-bottom:0.5rem; color:var(--text);">Keyboard Shortcuts</div>
    <div class="shortcut-row"><span>Toggle timer</span><kbd>Space</kbd></div>
    <div class="shortcut-row"><span>Life happens</span><kbd>Esc</kbd></div>
    <div class="shortcut-row"><span>Add task</span><kbd>N</kbd></div>
    <div class="shortcut-row"><span>Ripple shift</span><kbd>R</kbd></div>
    <div class="shortcut-row"><span>Generate plan</span><kbd>G</kbd></div>
    <div class="shortcut-row"><span>Shortcuts</span><kbd>?</kbd></div>
  </div>

  <div class="ripple-indicator" id="ripple-indicator">
    <div style="font-size:0.8rem; color:var(--muted); margin-bottom:0.25rem;">Schedule Shifted</div>
    <div class="ripple-amount">+<span id="ripple-display">15</span>m</div>
  </div>

  <script>
    (function () {
      'use strict';

      // ============================================================
      // CONSTANTS
      // ============================================================
      const STORAGE_KEY = 'sanctuary_ultimate_v2';
      const TZ = 'Europe/London';
      const CIRCUMFERENCE = 2 * Math.PI * 94; // r=94

      const DEFAULT_EXAMS = [
        { id: 'e1', date: '2026-01-06', subjects: ['English', 'Business'], completed: false, type: 'exam' },
        { id: 'e2', date: '2026-01-07', subjects: ['Physics', 'Computer Science'], completed: false, type: 'exam' },
        { id: 'e3', date: '2026-01-08', subjects: ['Chemistry', 'History'], completed: false, type: 'exam' },
        { id: 'e4', date: '2026-01-09', subjects: ['German'], completed: false, type: 'exam' },
        { id: 'e5', date: '2026-01-10', subjects: ['Engineering Project'], completed: false, type: 'deadline' },
        { id: 'e6', date: '2026-01-12', subjects: ['Biology'], completed: false, type: 'exam' },
        { id: 'e7', date: '2026-01-14', subjects: ['Maths', 'Latin'], completed: false, type: 'exam' },
        { id: 'e8', date: '2026-01-15', subjects: ['English Literature'], completed: false, type: 'exam' },
        { id: 'e9', date: '2026-01-24', subjects: ['Interviews'], completed: false, type: 'event' }
      ];

      const ALL_SUBJECTS = [
        'English', 'Business', 'Physics', 'Computer Science',
        'Chemistry', 'History', 'German', 'Biology',
        'Maths', 'Latin', 'English Literature', 'Engineering Project', 'General'
      ];

      // ============================================================
      // DOM HELPERS
      // ============================================================
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      // ============================================================
      // TIME (UK-safe)
      // ============================================================
      const pad = (n) => String(n).padStart(2, '0');

      function ukParts(date = new Date()) {
        const fmt = new Intl.DateTimeFormat('en-GB', {
          timeZone: TZ,
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit',
          hourCycle: 'h23'
        });
        const parts = fmt.formatToParts(date);
        const map = {};
        for (const p of parts) map[p.type] = p.value;
        return {
          year: Number(map.year),
          month: Number(map.month),
          day: Number(map.day),
          hour: Number(map.hour),
          minute: Number(map.minute)
        };
      }

      function todayISO() {
        const p = ukParts();
        return `${p.year}-${pad(p.month)}-${pad(p.day)}`;
      }

      function nowMinutesUK() {
        const p = ukParts();
        return p.hour * 60 + p.minute;
      }

      function isoToUtcMidnightMs(isoDate) {
        // isoDate: YYYY-MM-DD
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(isoDate);
        if (!m) return NaN;
        const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
        return Date.UTC(y, mo - 1, d);
      }

      function daysDiffUK(targetIsoDate) {
        const t = isoToUtcMidnightMs(targetIsoDate);
        if (!Number.isFinite(t)) return NaN;
        const uk = ukParts();
        const todayUtc = Date.UTC(uk.year, uk.month - 1, uk.day);
        return Math.round((t - todayUtc) / 86400000);
      }

      const minToTime = (m) => `${pad(Math.floor((m % 1440 + 1440) % 1440 / 60))}:${pad((m % 1440 + 1440) % 1440 % 60)}`;
      const minToTimeLabel = (m) => {
        const days = Math.floor(m / 1440);
        const label = minToTime(m);
        return days > 0 ? `+${days}d ${label}` : label;
      };
      const timeToMin = (t) => {
        const [h, m] = t.split(':').map(Number);
        if (!Number.isFinite(h) || !Number.isFinite(m)) return 0;
        return h * 60 + m;
      };

      const formatTime = (sec) => `${pad(Math.floor(sec / 60))}:${pad(sec % 60)}`;
      const formatDuration = (sec) => {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        return h > 0 ? `${h}h ${m}m` : `${m}m`;
      };

      function ukDateKeyFromTimestamp(ts) {
        const d = new Date(ts);
        // en-CA => YYYY-MM-DD style
        return d.toLocaleDateString('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
      }

      // ============================================================
      // UID
      // ============================================================
      const uid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2));

      // ============================================================
      // HAPTICS
      // ============================================================
      function vibrate(pattern) {
        try {
          if (navigator.vibrate) navigator.vibrate(pattern);
        } catch (_) {}
      }

      // ============================================================
      // STATE
      // ============================================================
      const baseState = {
        version: 2,
        theme: 'slate',
        onboarded: false,

        exams: [],
        tasks: [],
        logs: [],

        selectedDate: todayISO(),

        energyLevel: null,
        lastEnergyDate: null,

        // timer
        currentSubject: null,
        timerSeconds: 1500,
        timerTotalSeconds: 1500,
        timerRunning: false,
        timerPaused: false,

        // streak
        streak: 0,
        streakGraceDays: 1
      };

      let state = structuredClone(baseState);

      // ============================================================
      // PERSISTENCE + NORMALIZATION
      // ============================================================
      function normalizeState(s) {
        const out = { ...structuredClone(baseState), ...(s && typeof s === 'object' ? s : {}) };

        out.theme = typeof out.theme === 'string' ? out.theme : 'slate';
        out.onboarded = !!out.onboarded;

        out.exams = Array.isArray(out.exams) ? out.exams : [];
        out.tasks = Array.isArray(out.tasks) ? out.tasks : [];
        out.logs = Array.isArray(out.logs) ? out.logs : [];

        out.selectedDate = typeof out.selectedDate === 'string' ? out.selectedDate : todayISO();

        // ids as strings
        out.exams = out.exams.map((e, i) => ({
          id: String(e.id ?? `ex_${i}_${uid()}`),
          date: typeof e.date === 'string' ? e.date : todayISO(),
          subjects: Array.isArray(e.subjects) ? e.subjects.map(String).filter(Boolean) : [],
          completed: !!e.completed,
          type: typeof e.type === 'string' ? e.type : 'exam'
        }));

        out.tasks = out.tasks.map((t, i) => ({
          id: String(t.id ?? `t_${i}_${uid()}`),
          date: typeof t.date === 'string' ? t.date : todayISO(),
          title: String(t.title ?? 'Untitled'),
          start: Number.isFinite(t.start) ? t.start : 9 * 60,
          duration: Number.isFinite(t.duration) ? t.duration : 45,
          done: !!t.done,
          type: typeof t.type === 'string' ? t.type : (String(t.title || '').toLowerCase().includes('break') ? 'break' : 'study'),
          subject: typeof t.subject === 'string' ? t.subject : ''
        }));

        out.logs = out.logs.map((l, i) => ({
          id: String(l.id ?? `l_${i}_${uid()}`),
          subject: String(l.subject ?? 'Focus'),
          duration: Number.isFinite(l.duration) ? l.duration : 0,
          timestamp: typeof l.timestamp === 'string' ? l.timestamp : new Date().toISOString(),
          dateKey: typeof l.dateKey === 'string' ? l.dateKey : ukDateKeyFromTimestamp(l.timestamp)
        })).filter(l => l.duration >= 0);

        out.energyLevel = Number.isFinite(out.energyLevel) ? out.energyLevel : null;
        out.lastEnergyDate = typeof out.lastEnergyDate === 'string' ? out.lastEnergyDate : null;

        out.timerSeconds = Number.isFinite(out.timerSeconds) ? out.timerSeconds : 1500;
        out.timerTotalSeconds = Number.isFinite(out.timerTotalSeconds) ? out.timerTotalSeconds : out.timerSeconds;

        out.timerRunning = !!out.timerRunning;
        out.timerPaused = !!out.timerPaused;

        out.streak = Number.isFinite(out.streak) ? out.streak : 0;
        out.streakGraceDays = Number.isFinite(out.streakGraceDays) ? out.streakGraceDays : 1;

        return out;
      }

      function loadState() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) state = normalizeState(JSON.parse(saved));
          else state = normalizeState({});
          if (!state.exams.length) state.exams = structuredClone(DEFAULT_EXAMS);
          // Always reset selectedDate to UK-today on load
          state.selectedDate = todayISO();
        } catch (e) {
          console.error('Load error:', e);
          state = normalizeState({});
          state.exams = structuredClone(DEFAULT_EXAMS);
          state.selectedDate = todayISO();
        }
      }

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error('Save error:', e);
        }
      }

      // ============================================================
      // TOASTS
      // ============================================================
      function showToast(message, type = 'success', icon = '‚úì') {
        const container = $('#toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
        container.appendChild(toast);

        requestAnimationFrame(() => toast.classList.add('show'));

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3200);
      }

      // ============================================================
      // MODALS
      // ============================================================
      function openModal(id) { $(`#${id}`).classList.add('open'); }
      function closeModal(id) { $(`#${id}`).classList.remove('open'); }
      function closeAllModals() { $$('.modal-overlay').forEach(m => m.classList.remove('open')); }

      // close on overlay click
      function bindOverlayClose() {
        $$('.modal-overlay').forEach(overlay => {
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.classList.remove('open');
          });
        });
        $$('[data-close]').forEach(btn => {
          btn.addEventListener('click', () => closeModal(btn.getAttribute('data-close')));
        });
      }

      // ============================================================
      // THEME
      // ============================================================
      function setTheme(theme) {
        document.documentElement.dataset.theme = theme;
        state.theme = theme;
        saveState();
      }

      // ============================================================
      // CLOCK
      // ============================================================
      function updateClock() {
        const now = new Date();
        $('#clock-time').textContent = now.toLocaleTimeString('en-GB', {
          timeZone: TZ, hour: '2-digit', minute: '2-digit'
        });
        $('#clock-date').textContent = now.toLocaleDateString('en-GB', {
          timeZone: TZ, weekday: 'short', day: 'numeric', month: 'short'
        }) + ' (UK)';
      }

      // ============================================================
      // CONFETTI (GEMINI-style)
      // ============================================================
      const Confetti = {
        fire() {
          const canvas = $('#confetti');
          const ctx = canvas.getContext('2d');
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;

          const particles = [];
          const count = 160;

          for (let i = 0; i < count; i++) {
            particles.push({
              x: canvas.width / 2,
              y: canvas.height / 2,
              vx: (Math.random() - 0.5) * 16,
              vy: (Math.random() - 0.5) * 16 - 6,
              color: `hsl(${Math.random() * 360}, 85%, 60%)`,
              size: Math.random() * 7 + 3,
              rotation: Math.random() * 360,
              rotationSpeed: (Math.random() - 0.5) * 12
            });
          }

          function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = particles.length - 1; i >= 0; i--) {
              const p = particles[i];
              p.x += p.vx;
              p.y += p.vy;
              p.vy += 0.32;
              p.vx *= 0.99;
              p.rotation += p.rotationSpeed;

              ctx.save();
              ctx.translate(p.x, p.y);
              ctx.rotate((p.rotation * Math.PI) / 180);
              ctx.fillStyle = p.color;
              ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
              ctx.restore();

              if (p.y > canvas.height + 80) particles.splice(i, 1);
            }

            if (particles.length > 0) requestAnimationFrame(draw);
          }

          draw();
        }
      };

      // ============================================================
      // AUDIO (compat fix)
      // ============================================================
      let audioCtx = null;

      function initAudio() {
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === 'suspended') audioCtx.resume();
        } catch (_) {
          audioCtx = null;
        }
      }

      function playSound(freq = 800, duration = 0.25) {
        if (!audioCtx) return;
        try {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
          osc.start();
          osc.stop(audioCtx.currentTime + duration);
        } catch (_) {}
      }

      function playSuccessSound() {
        initAudio();
        if (!audioCtx) return;
        [523, 659, 784].forEach((f, i) => setTimeout(() => playSound(f, 0.18), i * 140));
      }

      // ============================================================
      // ENERGY (GROK + used in plan gen + timer sizing)
      // ============================================================
      function getOptimalDurationSeconds(energyLevel) {
        const e = energyLevel ?? state.energyLevel ?? 3;
        if (e <= 1) return 15 * 60;
        if (e <= 2) return 20 * 60;
        if (e >= 5) return 35 * 60;
        if (e >= 4) return 30 * 60;
        return 25 * 60;
      }

      function setEnergy(level) {
        state.energyLevel = level;
        state.lastEnergyDate = todayISO();

        $$('.energy-option').forEach(opt => {
          opt.classList.toggle('selected', opt.dataset.energy === String(level));
        });

        // If timer is not running, apply immediately to next session baseline
        if (!state.timerRunning) {
          const dur = getOptimalDurationSeconds(level);
          state.timerTotalSeconds = dur;
          state.timerSeconds = Math.min(state.timerSeconds, dur);
          timerDriver.set(state.timerSeconds, state.timerTotalSeconds);
          updateTimerDisplay();
        }

        $('#energy-checkin').style.display = 'none';
        saveState();

        vibrate([12]);

        const mins = Math.round(getOptimalDurationSeconds(level) / 60);
        showToast(
          level <= 2 ? `Low energy ‚Üí ${mins}min focus sessions üíö` : `Energy set ‚Üí ${mins}min focus sessions üí™`,
          level <= 2 ? 'warn' : 'success',
          level <= 2 ? 'üí§' : '‚ö°'
        );
      }

      function showEnergyCheckin(force = false) {
        const today = todayISO();
        const shouldHide = state.lastEnergyDate === today && Number.isFinite(state.energyLevel);
        $('#energy-checkin').style.display = (force || !shouldHide) ? 'block' : 'none';
      }

      // ============================================================
      // EXAMS (CRUD)
      // ============================================================
      function renderExams() {
        const list = $('#exam-list');
        const sorted = [...state.exams].sort((a, b) => isoToUtcMidnightMs(a.date) - isoToUtcMidnightMs(b.date));

        if (!sorted.length) {
          list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìÖ</div><div class="empty-text">No exams scheduled</div></div>`;
          updateStats();
          return;
        }

        list.innerHTML = sorted.map(exam => {
          const days = daysDiffUK(exam.date);
          const completed = exam.completed || (Number.isFinite(days) && days < 0);

          let statusClass = '';
          let tag = '';
          if (completed) statusClass = 'completed';
          else if (days === 0) { statusClass = 'today'; tag = `<span class="tag tag-today">TODAY</span>`; }
          else if (days === 1) { statusClass = 'tomorrow'; tag = `<span class="tag tag-tomorrow">TOMORROW</span>`; }
          else if (Number.isFinite(days) && days <= 3) { tag = `<span class="tag tag-soon">SOON</span>`; }

          const dateStr = new Date(exam.date + 'T00:00:00Z').toLocaleDateString('en-GB', {
            timeZone: TZ, weekday: 'short', day: 'numeric', month: 'short'
          });

          const countdown =
            completed ? '‚úÖ' :
            !Number.isFinite(days) ? '‚Äî' :
            days === 0 ? 'üî¥' :
            days === 1 ? 'üü†' :
            `${days}d`;

          const typeIcon = exam.type === 'deadline' ? 'üìå' : exam.type === 'event' ? 'üéüÔ∏è' : 'üìù';

          return `
            <div class="exam-item ${statusClass}" data-id="${exam.id}">
              <div style="flex:1; min-width:0;">
                <div class="exam-date">${typeIcon} ${dateStr} ${tag}</div>
                <div class="exam-title">${(exam.subjects || []).join(' & ') || '(Untitled)'}</div>
              </div>
              <div class="exam-countdown">${countdown}</div>
              <div class="exam-actions">
                <button class="btn btn-icon btn-sm btn-ghost" data-edit="${exam.id}" title="Edit" aria-label="Edit exam">‚úé</button>
                <button class="btn btn-icon btn-sm btn-ghost" data-toggle="${exam.id}" title="Toggle Complete" aria-label="Toggle exam complete">‚úì</button>
              </div>
            </div>
          `;
        }).join('');

        updateStats();
      }

      function openExamModal(id = null) {
        const exam = id ? state.exams.find(e => e.id === id) : null;
        $('#modal-exam-title').textContent = exam ? '‚úèÔ∏è Edit Item' : '‚ûï Add Item';
        $('#exam-date').value = exam ? exam.date : '';
        $('#exam-subjects').value = exam ? (exam.subjects || []).join(', ') : '';
        $('#exam-type').value = exam ? (exam.type || 'exam') : 'exam';
        $('#exam-edit-id').value = exam ? exam.id : '';
        $('#btn-delete-exam').style.display = exam ? 'block' : 'none';
        openModal('modal-exam');
      }

      function saveExam() {
        const date = $('#exam-date').value;
        const subjectsText = $('#exam-subjects').value;
        const type = $('#exam-type').value;
        const editId = $('#exam-edit-id').value;

        if (!date || !subjectsText.trim()) {
          showToast('Please fill in date + subjects', 'error', '‚ö†Ô∏è');
          return;
        }

        const subjectList = subjectsText.split(',').map(s => s.trim()).filter(Boolean);
        if (!subjectList.length) {
          showToast('Please add at least one subject', 'error', '‚ö†Ô∏è');
          return;
        }

        if (editId) {
          const exam = state.exams.find(e => e.id === editId);
          if (exam) {
            exam.date = date;
            exam.subjects = subjectList;
            exam.type = type || 'exam';
          }
          showToast('Updated!', 'success', '‚úì');
        } else {
          state.exams.push({ id: uid(), date, subjects: subjectList, completed: false, type: type || 'exam' });
          showToast('Added!', 'success', '‚ûï');
        }

        saveState();
        renderExams();
        populateSubjects();
        closeModal('modal-exam');
      }

      function deleteExam() {
        const editId = $('#exam-edit-id').value;
        if (!editId) return;
        state.exams = state.exams.filter(e => e.id !== editId);
        saveState();
        renderExams();
        populateSubjects();
        closeModal('modal-exam');
        showToast('Deleted', 'warn', 'üóëÔ∏è');
      }

      function toggleExamComplete(id) {
        const exam = state.exams.find(e => e.id === id);
        if (!exam) return;
        exam.completed = !exam.completed;
        saveState();
        renderExams();
        showToast(exam.completed ? 'Marked complete! üéâ' : 'Marked incomplete', exam.completed ? 'success' : 'info', exam.completed ? 'üéâ' : '‚ÑπÔ∏è');
        if (exam.completed) vibrate([18, 10, 18]);
      }

      // ============================================================
      // TASKS (CRUD + drag/drop + buttons for mobile reorder)
      // ============================================================
      function dayTasks(dateIso) {
        return state.tasks.filter(t => t.date === dateIso);
      }

      function renderTasks() {
        const list = $('#task-list');
        $('#selected-date-tag').textContent = state.selectedDate + (state.selectedDate === todayISO() ? ' ‚Ä¢ Today' : '');

        const tasks = dayTasks(state.selectedDate).sort((a, b) => a.start - b.start);

        if (!tasks.length) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìã</div>
              <div class="empty-text">No tasks for this day</div>
              <button class="btn btn-sm" id="btn-empty-generate">‚ú® Generate Study Blocks</button>
            </div>
          `;
          $('#btn-empty-generate').addEventListener('click', generatePlan);
          return;
        }

        const isToday = (state.selectedDate === todayISO());
        const now = isToday ? nowMinutesUK() : -999999;

        list.innerHTML = tasks.map((task) => {
          const end = task.start + task.duration;
          const isActive = isToday && now >= task.start && now < end && !task.done;

          const chip = task.type === 'break' ? '‚òï Break'
            : task.type === 'buffer' ? 'ü´ß Buffer'
            : task.type === 'admin' ? 'üßæ Admin'
            : (task.subject ? `üìö ${task.subject}` : 'üìö Study');

          return `
            <div class="task-item ${isActive ? 'active' : ''} ${task.done ? 'done' : ''}"
                 data-id="${task.id}" draggable="true" role="button" aria-label="Task: ${task.title}">
              <div>
                <div class="task-time">${minToTimeLabel(task.start)}</div>
                <div class="task-duration">${task.duration}m ‚Ä¢ ends ${minToTimeLabel(end)}</div>
              </div>

              <div style="min-width:0;">
                <div class="task-title">${escapeHtml(task.title)}</div>
                <div class="task-chip">${chip}</div>
              </div>

              <div style="display:flex; align-items:center; gap:0.35rem;">
                <div class="task-status" title="Active status"></div>
                <button class="btn btn-icon btn-sm btn-ghost" data-task-up="${task.id}" title="Move up" aria-label="Move task up">‚Üë</button>
                <button class="btn btn-icon btn-sm btn-ghost" data-task-down="${task.id}" title="Move down" aria-label="Move task down">‚Üì</button>
                <button class="btn btn-icon btn-sm btn-ghost" data-task-toggle="${task.id}" title="Toggle done" aria-label="Toggle task done">‚úì</button>
                <button class="btn btn-icon btn-sm btn-ghost" data-task-delete="${task.id}" title="Delete" aria-label="Delete task">√ó</button>
              </div>
            </div>
          `;
        }).join('');

        initDragDrop();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        }[c]));
      }

      function openTaskModal(id = null) {
        const task = id ? state.tasks.find(t => t.id === id) : null;
        $('#modal-task-title').textContent = task ? '‚úèÔ∏è Edit Task' : '‚ûï Add Task';
        $('#task-title').value = task ? task.title : '';
        $('#task-start').value = task ? minToTime(task.start) : '09:00';
        $('#task-duration').value = task ? task.duration : 45;
        $('#task-type').value = task ? (task.type || 'study') : 'study';
        $('#task-subject').value = task ? (task.subject || '') : '';
        $('#task-edit-id').value = task ? task.id : '';
        openModal('modal-task');
      }

      function saveTask() {
        const title = $('#task-title').value.trim();
        const startTime = $('#task-start').value;
        const duration = Number($('#task-duration').value);
        const type = $('#task-type').value;
        const subject = $('#task-subject').value;
        const editId = $('#task-edit-id').value;

        if (!title) {
          showToast('Please enter a task name', 'error', '‚ö†Ô∏è');
          return;
        }
        if (!Number.isFinite(duration) || duration < 5 || duration > 240) {
          showToast('Duration must be 5‚Äì240 minutes', 'error', '‚ö†Ô∏è');
          return;
        }

        const start = timeToMin(startTime);

        if (editId) {
          const task = state.tasks.find(t => t.id === editId);
          if (task) {
            task.title = title;
            task.start = start;
            task.duration = duration;
            task.type = type;
            task.subject = subject;
          }
          showToast('Task updated', 'success', '‚úì');
        } else {
          state.tasks.push({
            id: uid(),
            date: state.selectedDate,
            title,
            start,
            duration,
            done: false,
            type,
            subject
          });
          showToast('Task added', 'success', '‚ûï');
        }

        saveState();
        renderTasks();
        populateSubjects();
        closeModal('modal-task');
        vibrate([10]);
      }

      function deleteTask(id) {
        state.tasks = state.tasks.filter(t => t.id !== id);
        saveState();
        renderTasks();
        showToast('Task deleted', 'info', 'üóëÔ∏è');
      }

      function toggleTaskDone(id) {
        const task = state.tasks.find(t => t.id === id);
        if (!task) return;
        task.done = !task.done;
        saveState();
        renderTasks();
        if (task.done) {
          initAudio(); playSound(600, 0.12);
          vibrate([12]);
        }
      }

      function moveTask(id, dir) {
        const tasks = dayTasks(state.selectedDate).sort((a, b) => a.start - b.start);
        const idx = tasks.findIndex(t => t.id === id);
        if (idx < 0) return;
        const to = idx + dir;
        if (to < 0 || to >= tasks.length) return;

        // reorder array in-place (by start-time ordering)
        const reordered = tasks.slice();
        const [moved] = reordered.splice(idx, 1);
        reordered.splice(to, 0, moved);

        // keep earliest start, pack sequentially (predictable, prevents overlap)
        let current = reordered[0].start;
        for (const t of reordered) {
          t.start = current;
          current += t.duration;
        }

        saveState();
        renderTasks();
        showToast('Reordered', 'info', '‚ÜïÔ∏è');
        vibrate([8]);
      }

      function initDragDrop() {
        const items = $$('.task-item[draggable]');
        let dragged = null;

        items.forEach(item => {
          item.addEventListener('click', (e) => {
            // ignore clicks on buttons
            if (e.target.closest('button')) return;
            const id = item.dataset.id;
            openTaskModal(id);
          });

          item.addEventListener('dragstart', (e) => {
            dragged = item;
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', item.dataset.id);
          });

          item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            $$('.task-item').forEach(i => i.classList.remove('drag-over'));
            dragged = null;
          });

          item.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (item !== dragged) item.classList.add('drag-over');
          });

          item.addEventListener('dragleave', () => item.classList.remove('drag-over'));

          item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('drag-over');
            const fromId = e.dataTransfer.getData('text/plain');
            const toId = item.dataset.id;
            if (!fromId || !toId || fromId === toId) return;

            const tasks = dayTasks(state.selectedDate).sort((a, b) => a.start - b.start);
            const fromIndex = tasks.findIndex(t => t.id === fromId);
            const toIndex = tasks.findIndex(t => t.id === toId);
            if (fromIndex < 0 || toIndex < 0) return;

            const reordered = tasks.slice();
            const [moved] = reordered.splice(fromIndex, 1);
            reordered.splice(toIndex, 0, moved);

            let current = reordered[0].start;
            for (const t of reordered) {
              t.start = current;
              current += t.duration;
            }

            saveState();
            renderTasks();
            showToast('Tasks reordered', 'info', '‚ÜïÔ∏è');
            vibrate([8]);
          });
        });
      }

      // ============================================================
      // PLAN GENERATION (uses energy + upcoming exams)
      // ============================================================
      function generatePlan() {
        const energy = state.energyLevel ?? 3;

        const focusBlock = (energy <= 2) ? 30 : (energy >= 4) ? 50 : 45;
        const breakBlock = (energy <= 2) ? 12 : 15;
        const microBuffer = 8;

        const upcoming = state.exams
          .filter(e => !e.completed && Number.isFinite(daysDiffUK(e.date)) && daysDiffUK(e.date) >= 0 && daysDiffUK(e.date) <= 7)
          .sort((a, b) => daysDiffUK(a.date) - daysDiffUK(b.date))
          .slice(0, 3);

        const subjects = (upcoming.length ? upcoming.flatMap(e => e.subjects) : ['General'])
          .map(s => String(s).trim()).filter(Boolean);

        const pick = (i) => subjects[i] || subjects[0] || 'General';

        let startTime = 9 * 60;
        const existing = dayTasks(state.selectedDate);
        if (existing.length) {
          const lastEnd = Math.max(...existing.map(t => t.start + t.duration));
          startTime = Math.max(startTime, lastEnd + 5);
        }

        const blocks = [
          { title: `${pick(0)} ‚Ä¢ Active Recall`, duration: focusBlock, type: 'study', subject: pick(0) },
          { title: 'Break ‚Ä¢ Water / snack', duration: breakBlock, type: 'break', subject: '' },
          { title: `${pick(1)} ‚Ä¢ Practice Questions`, duration: focusBlock, type: 'study', subject: pick(1) },
          { title: 'Break ‚Ä¢ Walk / reset', duration: breakBlock, type: 'break', subject: '' },
          { title: `${pick(2)} ‚Ä¢ Weak Areas`, duration: focusBlock, type: 'study', subject: pick(2) },
          { title: 'Buffer ‚Ä¢ Life happens', duration: 15, type: 'buffer', subject: '' },
          { title: 'Micro-buffer ‚Ä¢ tidy desk', duration: microBuffer, type: 'buffer', subject: '' },
        ];

        for (const b of blocks) {
          state.tasks.push({
            id: uid(),
            date: state.selectedDate,
            title: b.title,
            start: startTime,
            duration: b.duration,
            done: false,
            type: b.type,
            subject: b.subject
          });
          startTime += b.duration;
        }

        saveState();
        renderTasks();
        populateSubjects();
        showToast('Study blocks generated ‚ú®', 'success', '‚ú®');
        vibrate([14]);
      }

      // ============================================================
      // RIPPLE SHIFT (GROK: overlap resolution + visual indicator)
      // ============================================================
      function rippleShift(delayMinutes) {
        const tasksAll = dayTasks(state.selectedDate);
        if (!tasksAll.length) {
          showToast('No tasks to ripple', 'info', '‚ÑπÔ∏è');
          return;
        }

        const isToday = state.selectedDate === todayISO();
        const baseline = isToday ? nowMinutesUK() : -999999;

        // shift tasks that haven't started yet (or are just starting) and are not done
        for (const t of tasksAll) {
          if (!t.done && t.start >= baseline - 10) t.start += delayMinutes;
        }

        // resolve overlaps by sorting and packing from the last fixed end (tasks before baseline)
        const fixed = tasksAll.filter(t => t.start < baseline - 10).sort((a, b) => a.start - b.start);
        const remaining = tasksAll.filter(t => t.start >= baseline - 10).sort((a, b) => a.start - b.start);

        let prevEnd = fixed.length ? Math.max(...fixed.map(t => t.start + t.duration)) : 0;
        for (const t of remaining) {
          if (t.start < prevEnd) t.start = prevEnd;
          prevEnd = t.start + t.duration;
        }

        saveState();
        renderTasks();

        const indicator = $('#ripple-indicator');
        $('#ripple-display').textContent = delayMinutes;
        indicator.classList.add('visible');
        setTimeout(() => indicator.classList.remove('visible'), 2000);

        showToast(`Schedule shifted by ${delayMinutes}m ‚âã`, 'warn', '‚âã');
        vibrate([10, 20, 10]);
      }

      // ============================================================
      // TIMER (accurate worker + fallback)
      // ============================================================
      let timerWorker = null;

      const timerDriver = {
        mode: 'worker', // 'worker' | 'fallback'
        fallbackInterval: null,
        fallbackStartMs: 0,
        fallbackBase: 0,

        init() {
          if (!('Worker' in window)) {
            this.mode = 'fallback';
            return;
          }

          const workerCode = `
            let running = false;
            let timeLeft = 1500;
            let startTs = 0;
            let baseTime = 1500;

            self.onmessage = function(e) {
              const { action, payload } = e.data || {};
              if (action === 'start') {
                running = true;
                baseTime = typeof payload?.baseTime === 'number' ? payload.baseTime : baseTime;
                timeLeft = typeof payload?.timeLeft === 'number' ? payload.timeLeft : timeLeft;
                startTs = performance.now();
                tick();
              } else if (action === 'pause') {
                if (running) {
                  const elapsed = (performance.now() - startTs) / 1000;
                  timeLeft = Math.max(0, timeLeft - elapsed);
                  running = false;
                  self.postMessage({ type: 'paused', timeLeft: Math.floor(timeLeft) });
                }
              } else if (action === 'reset') {
                running = false;
                baseTime = typeof payload?.baseTime === 'number' ? payload.baseTime : 1500;
                timeLeft = baseTime;
                self.postMessage({ type: 'reset', timeLeft: Math.floor(timeLeft) });
              } else if (action === 'set') {
                baseTime = typeof payload?.baseTime === 'number' ? payload.baseTime : baseTime;
                timeLeft = typeof payload?.timeLeft === 'number' ? payload.timeLeft : timeLeft;
                self.postMessage({ type: 'set', timeLeft: Math.floor(timeLeft) });
              }
            };

            function tick() {
              if (!running) return;
              const elapsed = (performance.now() - startTs) / 1000;
              const remaining = Math.max(0, timeLeft - elapsed);
              self.postMessage({ type: 'tick', timeLeft: Math.floor(remaining) });
              if (remaining <= 0) {
                running = false;
                self.postMessage({ type: 'complete' });
              } else {
                setTimeout(tick, 250);
              }
            }
          `;
          const blob = new Blob([workerCode], { type: 'application/javascript' });
          timerWorker = new Worker(URL.createObjectURL(blob));

          timerWorker.onmessage = (e) => {
            const { type, timeLeft } = e.data || {};
            if (type === 'tick') {
              state.timerSeconds = timeLeft;
              updateTimerDisplay();
            } else if (type === 'complete') {
              handleSessionComplete();
            } else if (type === 'paused') {
              state.timerSeconds = timeLeft;
              state.timerRunning = false;
              state.timerPaused = true;
              updateTimerDisplay();
              saveState();
            } else if (type === 'reset' || type === 'set') {
              state.timerSeconds = timeLeft;
              updateTimerDisplay();
            }
          };
        },

        start() {
          if (this.mode === 'fallback') {
            this.fallbackStartMs = Date.now();
            this.fallbackBase = state.timerSeconds;
            clearInterval(this.fallbackInterval);
            this.fallbackInterval = setInterval(() => {
              const elapsed = Math.floor((Date.now() - this.fallbackStartMs) / 1000);
              const remaining = Math.max(0, this.fallbackBase - elapsed);
              state.timerSeconds = remaining;
              updateTimerDisplay();
              if (remaining <= 0) {
                clearInterval(this.fallbackInterval);
                handleSessionComplete();
              }
            }, 250);
            return;
          }

          timerWorker.postMessage({
            action: 'start',
            payload: { timeLeft: state.timerSeconds, baseTime: state.timerTotalSeconds }
          });
        },

        pause() {
          if (this.mode === 'fallback') {
            clearInterval(this.fallbackInterval);
            this.fallbackInterval = null;
            state.timerPaused = true;
            saveState();
            return;
          }
          timerWorker.postMessage({ action: 'pause' });
        },

        reset(totalSeconds) {
          if (this.mode === 'fallback') {
            clearInterval(this.fallbackInterval);
            this.fallbackInterval = null;
            state.timerTotalSeconds = totalSeconds;
            state.timerSeconds = totalSeconds;
            updateTimerDisplay();
            return;
          }
          timerWorker.postMessage({ action: 'reset', payload: { baseTime: totalSeconds } });
        },

        set(timeLeftSeconds, baseTimeSeconds) {
          if (this.mode === 'fallback') {
            state.timerSeconds = timeLeftSeconds;
            state.timerTotalSeconds = baseTimeSeconds;
            updateTimerDisplay();
            return;
          }
          timerWorker.postMessage({ action: 'set', payload: { timeLeft: timeLeftSeconds, baseTime: baseTimeSeconds } });
        }
      };

      function populateSubjects() {
        const examSubjects = state.exams.flatMap(e => e.subjects || []);
        const taskSubjects = state.tasks.map(t => t.subject).filter(Boolean);
        const all = [...new Set([...examSubjects, ...taskSubjects, ...ALL_SUBJECTS])].filter(Boolean);

        const fill = (sel, placeholder) => {
          const el = $(sel);
          const current = el.value;
          el.innerHTML = `<option value="">${placeholder}</option>` + all.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
          if (all.includes(current)) el.value = current;
        };

        fill('#subject-select', 'Select Focus Subject...');
        fill('#quick-subject', 'Quick log‚Ä¶');

        // task subject dropdown should include empty + subjects
        const ts = $('#task-subject');
        const cur = ts.value;
        ts.innerHTML = `<option value="">(Optional)</option>` + all.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        if (all.includes(cur)) ts.value = cur;
      }

      function selectSubject(subject) {
        state.currentSubject = subject || null;

        if (!subject) {
          $('#timer-status').textContent = 'Ready to focus';
          return;
        }

        const exam = state.exams.find(e => (e.subjects || []).includes(subject) && !e.completed && Number.isFinite(daysDiffUK(e.date)) && daysDiffUK(e.date) >= 0);
        if (exam) {
          const days = daysDiffUK(exam.date);
          const label = (days === 0) ? 'today' : (days === 1) ? 'tomorrow' : `in ${days}d`;
          $('#timer-status').textContent = `${subject} ‚Ä¢ ${exam.type === 'deadline' ? 'Due' : 'Exam'} ${label}`;
        } else {
          $('#timer-status').textContent = `Ready to study ${subject}`;
        }
      }

      function updateTimerDisplay() {
        $('#timer-display').textContent = formatTime(state.timerSeconds);

        const total = Math.max(1, state.timerTotalSeconds || getOptimalDurationSeconds());
        const progress = 1 - (state.timerSeconds / total);
        const offset = CIRCUMFERENCE * (1 - progress);
        $('#timer-progress').style.strokeDashoffset = String(offset);

        document.title = state.timerRunning ? `${formatTime(state.timerSeconds)} | Sanctuary` : 'Sanctuary | Ultimate Adaptive Navigator';
        $('#timer-ring').classList.toggle('running', state.timerRunning);
      }

      function toggleTimer() {
        initAudio();

        let subject = state.currentSubject;
        if (!subject) {
          subject = $('#subject-select').value;
          if (!subject) {
            showToast('Select a subject first', 'warn', '‚ö†Ô∏è');
            return;
          }
          selectSubject(subject);
        }

        if (state.timerRunning) {
          timerDriver.pause();
          state.timerRunning = false;
          state.timerPaused = true;
          $('#btn-timer-toggle').innerHTML = '‚ñ∂Ô∏è RESUME';
          $('#timer-status').textContent = 'Paused';
          playSound(420, 0.11);
          vibrate([10]);
        } else {
          // If starting fresh (not paused), set totals based on energy
          if (!state.timerPaused || state.timerSeconds <= 0 || state.timerSeconds > state.timerTotalSeconds) {
            const total = getOptimalDurationSeconds();
            state.timerTotalSeconds = total;
            state.timerSeconds = total;
            timerDriver.set(state.timerSeconds, state.timerTotalSeconds);
          }

          timerDriver.start();
          state.timerRunning = true;
          state.timerPaused = false;
          $('#btn-timer-toggle').innerHTML = '‚è∏Ô∏è PAUSE';
          playSound(650, 0.10);
          vibrate([14]);
        }

        saveState();
      }

      function resetTimer() {
        const total = getOptimalDurationSeconds();
        state.timerTotalSeconds = total;
        state.timerSeconds = total;
        state.timerRunning = false;
        state.timerPaused = false;

        timerDriver.reset(total);

        $('#btn-timer-toggle').innerHTML = '‚ñ∂Ô∏è START';
        $('#timer-status').textContent = state.currentSubject ? `Ready to study ${state.currentSubject}` : 'Ready to focus';
        updateTimerDisplay();
        saveState();
      }

      function studiedTimeSeconds() {
        const total = state.timerTotalSeconds || getOptimalDurationSeconds();
        return Math.max(0, total - state.timerSeconds);
      }

      function handleSessionComplete() {
        state.timerRunning = false;
        const duration = state.timerTotalSeconds || getOptimalDurationSeconds();

        logStudySession(state.currentSubject || 'Focus', duration);

        Confetti.fire();
        playSuccessSound();
        vibrate([20, 30, 20]);

        showToast('Session complete! üéâ', 'success', 'üéâ');

        resetTimer();
      }

      // ============================================================
      // LIFE HAPPENS
      // ============================================================
      function handleLifeHappens(action) {
        const studied = studiedTimeSeconds();
        closeAllModals();

        switch (action) {
          case 'pause':
            if (state.timerRunning) {
              timerDriver.pause();
              state.timerRunning = false;
              state.timerPaused = true;
            }
            $('#btn-timer-toggle').innerHTML = '‚ñ∂Ô∏è RESUME';
            showToast(`Paused. Studied ${formatDuration(studied)} so far.`, 'info', '‚è∏Ô∏è');
            vibrate([10]);
            break;

          case 'log-ripple':
            if (studied >= 60) logStudySession(state.currentSubject || 'Focus', studied);
            resetTimer();
            rippleShift(15);
            break;

          case 'log':
            if (studied >= 60) logStudySession(state.currentSubject || 'Focus', studied);
            resetTimer();
            break;

          case 'cancel':
            resetTimer();
            showToast('Session cancelled. Fresh start ready.', 'info', 'üîÑ');
            break;

          case 'breathe':
            if (state.timerRunning) timerDriver.pause();
            state.timerRunning = false;
            state.timerPaused = true;
            $('#btn-timer-toggle').innerHTML = '‚ñ∂Ô∏è RESUME';
            openModal('modal-breathing');
            break;
        }

        saveState();
      }

      // ============================================================
      // STUDY LOG
      // ============================================================
      function renderStudyLog() {
        const list = $('#log-list');
        const todayKey = todayISO(); // already UK ISO
        const todayLogs = state.logs
          .filter(l => (l.dateKey || ukDateKeyFromTimestamp(l.timestamp)) === todayKey)
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (!todayLogs.length) {
          list.innerHTML = `<div class="empty-state" style="padding:1rem;"><span style="color:var(--muted);">No sessions logged yet today</span></div>`;
          return;
        }

        list.innerHTML = todayLogs.map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString('en-GB', { timeZone: TZ, hour: '2-digit', minute: '2-digit' });
          return `
            <div class="log-item">
              <div>
                <div class="log-subject">${escapeHtml(log.subject)}</div>
                <div class="log-time">${time}</div>
              </div>
              <div class="log-duration">${formatDuration(log.duration)}</div>
            </div>
          `;
        }).join('');
      }

      function logStudySession(subject, durationSeconds) {
        const dur = Math.floor(durationSeconds);
        if (!Number.isFinite(dur) || dur < 60) return;

        const ts = new Date().toISOString();
        state.logs.push({
          id: uid(),
          subject: subject || 'Focus',
          duration: dur,
          timestamp: ts,
          dateKey: todayISO()
        });

        saveState();
        renderStudyLog();
        updateStats();
        showToast(`Logged ${formatDuration(dur)} of ${subject}!`, 'success', '‚úì');
      }

      function quickAddStudy() {
        const subject = $('#quick-subject').value;
        const minutes = Number($('#quick-minutes').value);

        if (!subject || !Number.isFinite(minutes) || minutes < 1 || minutes > 480) {
          showToast('Pick a subject + valid minutes (1‚Äì480)', 'warn', '‚ö†Ô∏è');
          return;
        }

        logStudySession(subject, Math.round(minutes * 60));
        $('#quick-subject').value = '';
        $('#quick-minutes').value = '';
        vibrate([10]);
      }

      function clearTodayLog() {
        const key = todayISO();
        state.logs = state.logs.filter(l => (l.dateKey || ukDateKeyFromTimestamp(l.timestamp)) !== key);
        saveState();
        renderStudyLog();
        updateStats();
        showToast('Today‚Äôs log cleared', 'info', 'üóëÔ∏è');
      }

      // ============================================================
      // STATS + STREAK (GROK grace day)
      // ============================================================
      function updateStreak() {
        const keys = new Set(state.logs.map(l => l.dateKey || ukDateKeyFromTimestamp(l.timestamp)));

        let streak = 0;
        let graceUsed = 0;
        const graceMax = Math.max(0, state.streakGraceDays || 1);

        // walk backwards from yesterday if today has none
        let cursorMs = isoToUtcMidnightMs(todayISO());
        // Don't count "missing today" against streak yet
        // Start from today, but if no study, allow to skip today without spending grace.
        for (;;) {
          const key = new Date(cursorMs).toLocaleDateString('en-CA', { timeZone: 'UTC', year: 'numeric', month: '2-digit', day: '2-digit' });
          // key is UTC-based ISO; since cursorMs is UTC midnight of UK date, this matches YYYY-MM-DD
          const has = keys.has(key);

          // special: first iteration (today) does not break streak
          if (streak === 0 && key === todayISO() && !has) {
            cursorMs -= 86400000;
            continue;
          }

          if (has) {
            streak++;
            cursorMs -= 86400000;
            continue;
          }

          if (streak > 0 && graceUsed < graceMax) {
            graceUsed++;
            cursorMs -= 86400000;
            continue;
          }

          break;
        }

        state.streak = streak;
      }

      function updateStats() {
        const done = state.exams.filter(e => e.completed).length;
        const left = state.exams.filter(e => !e.completed).length;
        $('#stat-done').textContent = String(done);
        $('#stat-left').textContent = String(left);

        const totalSeconds = state.logs.reduce((sum, l) => sum + (l.duration || 0), 0);
        $('#stat-hours').textContent = (totalSeconds / 3600).toFixed(1) + 'h';

        updateStreak();
        $('#stat-streak').textContent = String(state.streak);

        saveState();
      }

      // ============================================================
      // EXPORT / IMPORT (validated)
      // ============================================================
      function exportData() {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sanctuary-backup-${todayISO()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup downloaded', 'success', 'üì•');
      }

      function importData(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(String(e.target.result || ''));
            state = normalizeState(imported);
            // Always align selectedDate to UK today on import
            state.selectedDate = todayISO();
            saveState();
            renderAll();
            showToast('Imported successfully', 'success', 'üì§');
          } catch (err) {
            showToast('Invalid backup file', 'error', '‚ö†Ô∏è');
          }
        };
        reader.readAsText(file);
      }

      // ============================================================
      // SHORTCUTS + GUARDS
      // ============================================================
      function isTypingContext() {
        const el = document.activeElement;
        if (!el) return false;
        const tag = el.tagName.toLowerCase();
        return tag === 'input' || tag === 'textarea' || tag === 'select' || el.isContentEditable;
      }

      function toggleShortcutsPanel(force) {
        const panel = $('#shortcuts-panel');
        if (typeof force === 'boolean') panel.classList.toggle('visible', force);
        else panel.classList.toggle('visible');
      }

      // ============================================================
      // ONBOARDING (guided)
      // ============================================================
      const onboardingSteps = [
        'Pick your energy level (‚ö°). Sanctuary will size focus sessions to match your brain today.',
        'Generate a plan (‚ú®) to chunk the day into realistic blocks + buffers.',
        'Start a focus session. If life interrupts, hit ‚ÄúLife Happens‚Äù and ripple-shift the day without overlaps.'
      ];
      let onboardingIndex = 0;

      function openOnboarding(force = false) {
        if (state.onboarded && !force) return;
        onboardingIndex = 0;
        $('#onboarding-text').textContent = onboardingSteps[0];
        openModal('modal-onboarding');
      }

      function nextOnboarding() {
        onboardingIndex++;
        if (onboardingIndex >= onboardingSteps.length) {
          state.onboarded = true;
          saveState();
          closeModal('modal-onboarding');
          showToast('You‚Äôre ready. One step at a time.', 'success', '‚ú®');
          return;
        }
        $('#onboarding-text').textContent = onboardingSteps[onboardingIndex];
      }

      function skipOnboarding() {
        state.onboarded = true;
        saveState();
        closeModal('modal-onboarding');
      }

      // ============================================================
      // DATE NAV
      // ============================================================
      function setSelectedDate(iso) {
        state.selectedDate = iso;
        $('#selected-date').value = iso;
        saveState();
        renderTasks();
      }

      function shiftSelectedDate(days) {
        const ms = isoToUtcMidnightMs(state.selectedDate);
        if (!Number.isFinite(ms)) return;
        const newMs = ms + days * 86400000;
        const iso = new Date(newMs).toLocaleDateString('en-CA', { timeZone: 'UTC', year: 'numeric', month: '2-digit', day: '2-digit' });
        setSelectedDate(iso);
      }

      // ============================================================
      // RENDER ALL
      // ============================================================
      function renderAll() {
        $('#theme-select').value = state.theme;
        document.documentElement.dataset.theme = state.theme;

        $('#selected-date').value = state.selectedDate;

        renderExams();
        renderTasks();
        renderStudyLog();
        populateSubjects();
        showEnergyCheckin(false);

        // Keep timer baseline coherent
        if (!Number.isFinite(state.timerTotalSeconds) || state.timerTotalSeconds <= 0) {
          const t = getOptimalDurationSeconds();
          state.timerTotalSeconds = t;
          state.timerSeconds = Math.min(state.timerSeconds || t, t);
        }
        updateTimerDisplay();
        selectSubject(state.currentSubject);

        updateStats();
      }

      // ============================================================
      // EVENT BINDINGS
      // ============================================================
      function bindEvents() {
        // theme
        $('#theme-select').addEventListener('change', (e) => setTheme(e.target.value));

        // export/import
        $('#btn-export').addEventListener('click', exportData);
        $('#btn-import').addEventListener('click', () => $('#import-file').click());
        $('#import-file').addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (file) importData(file);
          e.target.value = '';
        });

        // shortcuts panel
        $('#btn-shortcuts').addEventListener('click', () => toggleShortcutsPanel());
        document.addEventListener('keydown', (e) => {
          if (isTypingContext()) return;

          if (e.key === '?' || (e.shiftKey && e.key === '/')) {
            e.preventDefault();
            toggleShortcutsPanel();
            return;
          }

          if (e.code === 'Space') {
            e.preventDefault();
            toggleTimer();
            return;
          }

          if (e.key === 'Escape') {
            e.preventDefault();
            openModal('modal-life-happens');
            return;
          }

          if (e.key.toLowerCase() === 'n') { e.preventDefault(); openTaskModal(null); return; }
          if (e.key.toLowerCase() === 'r') { e.preventDefault(); openModal('modal-ripple'); return; }
          if (e.key.toLowerCase() === 'g') { e.preventDefault(); generatePlan(); return; }
        });

        // onboarding
        $('#btn-onboarding').addEventListener('click', () => openOnboarding(true));
        $('#btn-onboarding-next').addEventListener('click', nextOnboarding);
        $('#btn-onboarding-skip').addEventListener('click', skipOnboarding);

        // exams
        $('#btn-add-exam').addEventListener('click', () => openExamModal(null));
        $('#btn-save-exam').addEventListener('click', saveExam);
        $('#btn-delete-exam').addEventListener('click', deleteExam);

        $('#exam-list').addEventListener('click', (e) => {
          const edit = e.target.closest('[data-edit]');
          const toggle = e.target.closest('[data-toggle]');
          const card = e.target.closest('.exam-item');

          if (edit) { e.stopPropagation(); openExamModal(edit.getAttribute('data-edit')); return; }
          if (toggle) { e.stopPropagation(); toggleExamComplete(toggle.getAttribute('data-toggle')); return; }
          if (card) { openExamModal(card.getAttribute('data-id')); }
        });

        // tasks
        $('#btn-add-task').addEventListener('click', () => openTaskModal(null));
        $('#btn-save-task').addEventListener('click', saveTask);
        $('#btn-generate-plan').addEventListener('click', generatePlan);
        $('#btn-ripple').addEventListener('click', () => openModal('modal-ripple'));
        $('#btn-confirm-ripple').addEventListener('click', () => {
          const val = Number($('#ripple-amount').value);
          if (!Number.isFinite(val) || val < 5 || val > 180) {
            showToast('Delay must be 5‚Äì180 minutes', 'error', '‚ö†Ô∏è');
            return;
          }
          closeModal('modal-ripple');
          rippleShift(Math.round(val));
        });

        $('#task-list').addEventListener('click', (e) => {
          const tUp = e.target.closest('[data-task-up]');
          const tDown = e.target.closest('[data-task-down]');
          const tToggle = e.target.closest('[data-task-toggle]');
          const tDelete = e.target.closest('[data-task-delete]');

          if (tUp) { e.stopPropagation(); moveTask(tUp.getAttribute('data-task-up'), -1); return; }
          if (tDown) { e.stopPropagation(); moveTask(tDown.getAttribute('data-task-down'), +1); return; }
          if (tToggle) { e.stopPropagation(); toggleTaskDone(tToggle.getAttribute('data-task-toggle')); return; }
          if (tDelete) { e.stopPropagation(); deleteTask(tDelete.getAttribute('data-task-delete')); return; }
        });

        // date nav
        $('#selected-date').addEventListener('change', (e) => {
          const val = e.target.value;
          if (val) setSelectedDate(val);
        });
        $('#btn-date-prev').addEventListener('click', () => shiftSelectedDate(-1));
        $('#btn-date-next').addEventListener('click', () => shiftSelectedDate(+1));

        // energy
        $$('.energy-option').forEach(btn => btn.addEventListener('click', () => setEnergy(Number(btn.dataset.energy))));
        $('#btn-energy').addEventListener('click', () => showEnergyCheckin(true));

        // subject select
        $('#subject-select').addEventListener('change', (e) => {
          selectSubject(e.target.value);
          saveState();
        });

        // timer controls
        $('#btn-timer-toggle').addEventListener('click', toggleTimer);
        $('#btn-life-happens').addEventListener('click', () => openModal('modal-life-happens'));

        // life happens actions
        $('#modal-life-happens').addEventListener('click', (e) => {
          const btn = e.target.closest('[data-action]');
          if (!btn) return;
          handleLifeHappens(btn.getAttribute('data-action'));
        });

        // quick log
        $('#btn-quick-add').addEventListener('click', quickAddStudy);
        $('#btn-clear-log').addEventListener('click', clearTodayLog);

        // keep clock
        setInterval(updateClock, 1000);

        // re-render "active" highlight each minute
        setInterval(() => {
          if (state.selectedDate === todayISO()) renderTasks();
        }, 60000);

        // resize confetti canvas
        window.addEventListener('resize', () => {
          const c = $('#confetti');
          c.width = window.innerWidth;
          c.height = window.innerHeight;
        });
      }

      // ============================================================
      // BOOT
      // ============================================================
      loadState();
      timerDriver.init();
      bindOverlayClose();
      bindEvents();
      updateClock();
      renderAll();

      // show onboarding once
      if (!state.onboarded) openOnboarding(false);

      // expose small API for inline empty-state button safety (if any)
      window.Sanctuary = {
        generatePlan,
        rippleShift,
        openTaskModal,
        openExamModal
      };
    })();
  </script>
</body>
</html>

